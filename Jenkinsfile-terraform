pipeline {

    agent any

    environment {
        TF_DIR = "terraform/enviroments/dev"
        GIT_BRANCH_NAME = "main"
    }

    options {
        timestamps()
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Terraform Init') {
            steps {
                dir("${TF_DIR}") {
                    sh 'terraform init'
                }
            }
        }

        stage('Terraform Format Auto Fix') {
            steps {
                script {

                    def status = sh(
                        script: "terraform fmt -check -recursive terraform/",
                        returnStatus: true
                    )

                    if (status != 0) {

                        echo "Formatting issues found. Fixing..."

                        sh '''

                        terraform fmt -recursive terraform/

                        git config user.email "jenkins@cloudforge.com"
                        git config user.name "Jenkins"

                        # Fix detached HEAD problem
                        git checkout ${GIT_BRANCH_NAME}

                        git pull origin ${GIT_BRANCH_NAME}

                        git add terraform/

                        git commit -m "Auto terraform fmt fix" || true

                        git push origin ${GIT_BRANCH_NAME}

                        '''

                    } else {

                        echo "Terraform formatting OK"

                    }
                }
            }
        }

        stage('Terraform Validate') {
            steps {
                dir("${TF_DIR}") {
                    sh 'terraform validate'
                }
            }
        }

        stage('tfsec Security Scan') {
            steps {
                sh 'tfsec terraform/'
            }
        }

        stage('Checkov Security Scan') {
            steps {
                sh 'checkov -d terraform/'
            }
        }

        stage('Terraform Plan') {
            steps {
                dir("${TF_DIR}") {
                    sh 'terraform plan -out=tfplan'
                }
            }
        }

        stage('Archive Plan') {
            steps {
                archiveArtifacts artifacts: 'terraform/enviroments/dev/tfplan'
            }
        }

    }

}