pipeline {

    agent any

    environment {
        TF_DIR = "terraform/enviroments/dev"
        GIT_BRANCH = "main"
        GIT_REPO = "https://github.com/getAzeem/CloudForge.git"
    }

    options {
        timestamps()
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Prepare Git Branch') {
            steps {

                withCredentials([
                    usernamePassword(
                        credentialsId: 'Jenkins-access-github',
                        usernameVariable: 'GIT_USER',
                        passwordVariable: 'GIT_TOKEN'
                    )
                ]) {

                    sh '''

                    git fetch https://${GIT_USER}:${GIT_TOKEN}@github.com/getAzeem/CloudForge.git

                    git checkout -B ${GIT_BRANCH}

                    git reset --hard origin/${GIT_BRANCH}

                    '''

                }

            }
        }

        stage('Terraform Init') {
            steps {
                dir("${TF_DIR}") {
                    sh 'terraform init'
                }
            }
        }

        stage('Terraform Format Auto Fix') {
            steps {

                script {

                    def status = sh(
                        script: "terraform fmt -check -recursive terraform/",
                        returnStatus: true
                    )

                    if (status != 0) {

                        echo "Formatting issues found. Fixing..."

                        withCredentials([
                            usernamePassword(
                                credentialsId: 'Jenkins-access-github',
                                usernameVariable: 'GIT_USER',
                                passwordVariable: 'GIT_TOKEN'
                            )
                        ]) {

                            sh '''

                            terraform fmt -recursive terraform/

                            git config user.email "jenkins@cloudforge.com"
                            git config user.name "Jenkins"

                            git add terraform/

                            git commit -m "Auto terraform fmt fix" || true

                            git push https://${GIT_USER}:${GIT_TOKEN}@github.com/getAzeem/CloudForge.git ${GIT_BRANCH}

                            '''

                        }

                    } else {

                        echo "Terraform formatting OK"

                    }

                }
            }
        }

        stage('Terraform Validate') {
            steps {
                dir("${TF_DIR}") {
                    sh 'terraform validate'
                }
            }
        }

        stage('tfsec Security Scan') {
            steps {
                sh 'tfsec terraform/'
            }
        }

        stage('Checkov Security Scan') {
            steps {
                sh 'checkov -d terraform/'
            }
        }

        stage('Terraform Plan') {
            steps {
                dir("${TF_DIR}") {
                    sh 'terraform plan -out=tfplan'
                }
            }
        }

        stage('Archive Plan') {
            steps {
                archiveArtifacts artifacts: 'terraform/enviroments/dev/tfplan'
            }
        }

    }
}